name: ${COMPOSE_PROJECT_NAME:-code-compass}

services:
  qdrant:
    container_name: code-compass-qdrant
    image: ${QDRANT_IMAGE:-qdrant/qdrant:latest}
    restart: unless-stopped
    ports:
      - "${QDRANT_HTTP_PORT:-6333}:6333" # HTTP API
      - "${QDRANT_GRPC_PORT:-6334}:6334" # gRPC
    volumes:
      - "${QDRANT_STORAGE_PATH:-./qdrant_data}:/qdrant/storage:z"
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'exec 3<>/dev/tcp/127.0.0.1/6333'"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  indexer:
    profiles: ["indexer"]
    image: ${INDEXER_DOCKER_IMAGE:-python:3.11-slim}
    working_dir: /workspace/apps/indexer
    depends_on:
      qdrant:
        condition: service_healthy
    environment:
      QDRANT_URL: ${QDRANT_URL_DOCKER:-http://qdrant:6333}
      QDRANT_COLLECTION_BASE: ${QDRANT_COLLECTION_BASE:-compass__manutic_nomic_embed}
      QDRANT_COLLECTION_CODE: ${QDRANT_COLLECTION_CODE:-}
      QDRANT_COLLECTION_DOCS: ${QDRANT_COLLECTION_DOCS:-}
      QDRANT_DISTANCE: ${QDRANT_DISTANCE:-Cosine}
      REPO_ROOT: ${REPO_ROOT_DOCKER:-/workspace}
      REPO_ALLOWLIST: ${REPO_ALLOWLIST:-src,packages,apps,docs}
      REPO_BLOCKLIST: ${REPO_BLOCKLIST:-node_modules,dist,build,.next,.git,coverage}
      CHUNK_MAX_TOKENS: ${CHUNK_MAX_TOKENS:-800}
      CHUNK_OVERLAP_TOKENS: ${CHUNK_OVERLAP_TOKENS:-120}
      EMBEDDINGS_PROVIDER: ${EMBEDDINGS_PROVIDER:-openai}
      EMBEDDINGS_MODEL: ${EMBEDDINGS_MODEL:-text-embedding-3-large}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      INDEXER_RUN_MODULE: ${INDEXER_RUN_MODULE:-indexer}
    volumes:
      - ../:/workspace
      - indexer_pip_cache:/root/.cache/pip
    entrypoint: ["/bin/sh", "-lc"]
    command:
      - >
        set -e;
        if [ ! -d /workspace/apps/indexer ]; then
          echo 'Erro: diret처rio /workspace/apps/indexer n찾o encontrado.';
          exit 1;
        fi;
        cd /workspace/apps/indexer;
        python -m pip install --upgrade pip;
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt;
        elif [ -f pyproject.toml ]; then
          pip install -e .;
        else
          echo 'Erro: requirements.txt ou pyproject.toml n찾o encontrado em /workspace/apps/indexer.';
          exit 1;
        fi;
        if [ "$${INDEXER_MODE:-index}" = "incremental" ]; then
          echo 'Aviso: incremental ainda n찾o implementado no CLI; usando index completo.';
          INDEXER_MODE=index;
        fi;
        if [ "$${INDEXER_MODE:-index}" = "full" ]; then
          INDEXER_MODE=index;
        fi;
        PYTHONPATH=. python -m "$${INDEXER_RUN_MODULE}" "$${INDEXER_MODE:-index}";

volumes:
  indexer_pip_cache:
